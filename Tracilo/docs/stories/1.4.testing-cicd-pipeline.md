# Story 1.4: Testing Infrastructure & CI/CD Pipeline

## Status
Draft

## Story
**As a** development team,
**I want** a complete testing infrastructure and CI/CD pipeline that runs automated tests and deploys to staging,
**so that** we can ensure code quality and deploy features safely with confidence.

## Acceptance Criteria

1. **Testing Framework Setup:** Jest, React Testing Library, Supertest, and Detox configured and working across all packages
2. **Unit Test Coverage:** Sample tests written with >80% coverage for core components and API functions
3. **Integration Testing:** API integration tests and database testing operational
4. **CI/CD Pipeline:** GitHub Actions pipeline running tests, builds, and deploying to staging environment
5. **Code Quality Gates:** ESLint, Prettier, and TypeScript checks integrated into CI pipeline
6. **Deployment Automation:** Automatic deployment to Vercel staging environment on main branch commits

## Tasks / Subtasks

- [ ] **Task 1: Jest & Testing Library Setup** (AC: 1, 2)
  - [ ] Configure Jest for all packages with TypeScript support
  - [ ] Setup React Testing Library for mobile and web component testing
  - [ ] Configure test environment variables and mocks
  - [ ] Setup code coverage reporting with Istanbul
  - [ ] Create sample unit tests for shared utilities
  - [ ] Write component tests for basic UI elements

- [ ] **Task 2: API & Database Testing** (AC: 1, 3)
  - [ ] Configure Supertest for API endpoint testing
  - [ ] Setup test database with schema and migrations
  - [ ] Create integration tests for CRUD operations
  - [ ] Setup database cleanup and seeding for tests
  - [ ] Configure test environment isolation
  - [ ] Write authentication flow integration tests

- [ ] **Task 3: Mobile E2E Testing Setup** (AC: 1)
  - [ ] Configure Detox for React Native E2E testing
  - [ ] Setup Android emulator for CI testing
  - [ ] Create basic E2E test scenarios (login, navigation)
  - [ ] Configure screenshot and video recording for failures
  - [ ] Setup test app builds for E2E testing
  - [ ] Document E2E testing local setup

- [ ] **Task 4: Code Quality Pipeline** (AC: 5)
  - [ ] Configure ESLint rules for all packages
  - [ ] Setup Prettier for consistent code formatting
  - [ ] Configure TypeScript strict mode and type checking
  - [ ] Setup Husky pre-commit hooks
  - [ ] Configure lint-staged for staged file checking
  - [ ] Add commit message validation

- [ ] **Task 5: GitHub Actions CI Pipeline** (AC: 4, 5)
  - [ ] Create CI workflow for pull requests
  - [ ] Setup parallel job execution for different test types
  - [ ] Configure test caching for faster CI runs
  - [ ] Add build verification for all packages
  - [ ] Setup test result reporting and artifacts
  - [ ] Configure failure notifications

- [ ] **Task 6: Deployment Pipeline** (AC: 6)
  - [ ] Configure Vercel deployment from GitHub
  - [ ] Setup staging environment deployment
  - [ ] Configure environment variables for staging
  - [ ] Setup deployment status checks
  - [ ] Configure automatic preview deployments for PRs
  - [ ] Document deployment process and rollback

## Dev Notes

### Testing Strategy Overview
From Architecture Document (architecture.md#testing-strategy):

**Testing Pyramid:**
```
      E2E Tests (Detox)
     /              \
  Integration Tests (Supertest)
 /                            \
Frontend Unit (Jest+RTL)  Backend Unit (Jest)
```

### Jest Configuration
Based on Architecture Document (architecture.md#testing-organization):

**Test File Structure:**
```
apps/mobile/tests/
├── components/
├── screens/
├── hooks/
└── e2e/

apps/api/tests/
├── routers/
├── services/
└── integration/
```

**Jest Config Example:**
```javascript
module.exports = {
  preset: 'react-native',
  testEnvironment: 'node',
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80
    }
  },
  collectCoverageFrom: [
    'src/**/*.{ts,tsx}',
    '!src/**/*.d.ts',
    '!src/**/*.test.{ts,tsx}'
  ]
};
```

### API Testing Configuration
From Architecture Document (architecture.md#backend-tests):

**Supertest Integration:**
```typescript
import request from 'supertest';
import { app } from '../src/server';

describe('POST /trpc/organization.create', () => {
  it('should create organization with valid data', async () => {
    const response = await request(app)
      .post('/trpc/organization.create')
      .set('Authorization', `Bearer ${userToken}`)
      .send({
        name: 'Test Organization',
        subscriptionTier: 'basic'
      });

    expect(response.status).toBe(200);
    expect(response.body.result.data.name).toBe('Test Organization');
  });
});
```

### E2E Testing Setup
From Architecture Document (architecture.md#e2e-tests):

**Detox Configuration:**
```json
{
  "testRunner": "jest",
  "runnerConfig": "e2e/config.json",
  "configurations": {
    "android.emu.debug": {
      "type": "android.emulator",
      "binaryPath": "android/app/build/outputs/apk/debug/app-debug.apk",
      "device": {
        "avdName": "Pixel_4_API_30"
      }
    }
  }
}
```

### CI/CD Pipeline Configuration
From Architecture Document (architecture.md#ci-cd-pipeline):

**GitHub Actions Workflow:**
```yaml
name: CI/CD Pipeline
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: pnpm/action-setup@v2
      - run: pnpm install
      - run: pnpm lint
      - run: pnpm type-check
      - run: pnpm test
      - run: pnpm build

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
```

### Code Quality Configuration
From Architecture Document (architecture.md#coding-standards):

**ESLint Configuration:**
```json
{
  "extends": [
    "@react-native-community",
    "@typescript-eslint/recommended",
    "prettier"
  ],
  "rules": {
    "@typescript-eslint/no-unused-vars": "error",
    "@typescript-eslint/explicit-function-return-type": "warn",
    "react-hooks/exhaustive-deps": "error"
  }
}
```

**Pre-commit Hook Setup:**
```json
{
  "husky": {
    "hooks": {
      "pre-commit": "lint-staged",
      "commit-msg": "commitlint -E HUSKY_GIT_PARAMS"
    }
  },
  "lint-staged": {
    "*.{ts,tsx}": ["eslint --fix", "prettier --write", "git add"],
    "*.{json,md}": ["prettier --write", "git add"]
  }
}
```

### Deployment Configuration
From Architecture Document (architecture.md#deployment-architecture):

**Environment Setup:**
- Development: http://localhost:3000, http://localhost:3001
- Staging: https://staging.tracilo.app, https://api-staging.tracilo.app
- Production: https://tracilo.app, https://api.tracilo.app

**Vercel Configuration:**
```json
{
  "builds": [
    {
      "src": "apps/web/package.json",
      "use": "@vercel/next"
    },
    {
      "src": "apps/api/package.json",
      "use": "@vercel/node"
    }
  ],
  "routes": [
    {
      "src": "/api/(.*)",
      "dest": "apps/api/$1"
    },
    {
      "src": "/(.*)",
      "dest": "apps/web/$1"
    }
  ]
}
```

### Performance Testing
From Product Requirements Document (product-requirements.md#technical-requirements):

**Performance Targets:**
- CI/CD pipeline completion: <10 minutes
- Test suite execution: <5 minutes
- Build time: <3 minutes for incremental builds
- Deployment time: <2 minutes to staging

### Test Data Management
Based on multi-tenant requirements:

**Test Database Setup:**
- Isolated test database per CI run
- Automated schema migration testing
- Test data seeding and cleanup
- Organization isolation testing

### Testing
Based on Architecture Document (architecture.md#testing-strategy):

**Unit Testing:**
- All shared utilities must have unit tests
- Component testing for UI elements
- Service layer testing for business logic
- Minimum 80% code coverage for business logic

**Integration Testing:**
- API endpoint testing with authentication
- Database operation testing
- External API integration testing (mocked)
- Multi-tenant data isolation testing

**E2E Testing:**
- Critical user flows (login, checklist creation)
- Offline functionality testing
- Cross-platform compatibility testing
- Performance testing under load

**Testing Commands:**
```bash
# Run all tests
pnpm test

# Run tests with coverage
pnpm test:coverage

# Run E2E tests
pnpm test:e2e

# Run integration tests only
pnpm test:integration

# Run tests in watch mode
pnpm test:watch
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-18 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record
*This section is populated by the development agent during implementation*

### Agent Model Used
*Record the specific AI agent model and version used for development*

### Debug Log References
*Reference any debug logs or traces generated during development*

### Completion Notes List
*Notes about the completion of tasks and any issues encountered*

### File List
*List all files created, modified, or affected during story implementation*

## QA Results
*Results from QA Agent QA review of the completed story implementation*
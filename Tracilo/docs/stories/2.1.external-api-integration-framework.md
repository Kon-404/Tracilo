# Story 2.1: External API Integration Framework

## Status
Draft

## Story
**As a** system architect,
**I want** a robust external API integration framework for connecting with South African regulatory bodies,
**so that** we can reliably verify professional credentials with PIRB, SAQCC Gas, and Department of Labour APIs.

## Acceptance Criteria

1. **API Client Framework:** Generic API client with retry logic, rate limiting, and error handling for regulatory body integrations
2. **Configuration Management:** Environment-based configuration for different regulatory API endpoints and credentials
3. **Response Caching:** Redis-based caching system for API responses with appropriate TTL based on data sensitivity
4. **Fallback Mechanisms:** Manual verification workflows when APIs are unavailable or return errors
5. **Audit Logging:** Complete audit trail for all external API calls with request/response logging for compliance
6. **Health Monitoring:** API health checks and status monitoring with alerting for service degradation

## Tasks / Subtasks

- [ ] **Task 1: Generic API Client Foundation** (AC: 1, 2)
  - [ ] Create BaseAPIClient class with common request/response handling
  - [ ] Implement retry logic with exponential backoff (3 retries, 1s, 2s, 4s delays)
  - [ ] Add rate limiting middleware (100 requests/minute per API)
  - [ ] Configure environment-based API endpoints and credentials
  - [ ] Add request/response validation using Zod schemas
  - [ ] Implement timeout handling (30s default, configurable per API)

- [ ] **Task 2: Response Caching System** (AC: 3)
  - [ ] Setup Redis cache client with connection pooling
  - [ ] Implement cache key strategy (api:endpoint:hash pattern)
  - [ ] Configure TTL by data type (credentials: 24h, status: 1h)
  - [ ] Add cache invalidation for manual verification overrides
  - [ ] Implement cache warming for frequently accessed data
  - [ ] Add cache hit/miss metrics for monitoring

- [ ] **Task 3: Error Handling & Fallback** (AC: 4)
  - [ ] Create APIError classes for different failure types
  - [ ] Implement circuit breaker pattern (5 failures = 30s cooldown)
  - [ ] Add manual verification workflow triggers
  - [ ] Create notification system for API failures
  - [ ] Implement graceful degradation with cached data
  - [ ] Add admin override capabilities for urgent verifications

- [ ] **Task 4: Audit & Compliance Logging** (AC: 5)
  - [ ] Create audit log schema with required compliance fields
  - [ ] Log all API requests with sanitized sensitive data
  - [ ] Store response metadata (status, duration, cache hit/miss)
  - [ ] Implement log retention policy (7 years for compliance)
  - [ ] Add POPIA compliance for personal data logging
  - [ ] Create audit report generation for compliance reviews

- [ ] **Task 5: Health Monitoring System** (AC: 6)
  - [ ] Implement API health check endpoints (/health/pirb, etc.)
  - [ ] Create status dashboard for API availability
  - [ ] Setup alerting for API response time degradation (>5s)
  - [ ] Monitor error rates and trigger alerts (>10% failure rate)
  - [ ] Implement uptime tracking and SLA monitoring
  - [ ] Add integration with Sentry for error aggregation

- [ ] **Task 6: Integration Testing Framework** (AC: 1, 4)
  - [ ] Create mock API servers for development testing
  - [ ] Write integration tests for each regulatory API
  - [ ] Test fallback scenarios and error conditions
  - [ ] Validate audit logging completeness
  - [ ] Performance test with simulated load
  - [ ] Create end-to-end verification workflow tests

## Dev Notes

### Previous Story Insights
No specific guidance found in architecture docs

### Data Models
From Architecture Document (architecture.md#external-apis):

**API Client Configuration:**
```typescript
interface APIConfig {
  baseUrl: string;
  apiKey: string;
  timeout: number;
  retryAttempts: number;
  rateLimitRpm: number;
  cacheTtl: number;
}

interface AuditLog {
  id: string;
  apiEndpoint: string;
  requestData: any; // Sanitized
  responseStatus: number;
  duration: number;
  cacheHit: boolean;
  timestamp: Date;
  userId?: string;
  organizationId?: string;
}
```

**External API Endpoints:**
- PIRB Database API: https://api.pirb.co.za/v1
- SAQCC Gas Database API: To be provided
- Department of Labour API: To be determined

[Source: architecture.md#external-apis]

### API Specifications
From Architecture Document (architecture.md#external-apis):

**PIRB Integration:**
- Purpose: Plumbing professional verification
- Base URL: https://api.pirb.co.za/v1
- Authentication: API key + certificate-based
- Rate Limits: 100 requests/minute
- Key Endpoint: POST /verify-professional

**SAQCC Gas Integration:**
- Purpose: Gas installation professional verification
- Documentation: Request from SAQCC Gas
- Rate Limits: Unknown - implement conservative limits

[Source: architecture.md#external-apis]

### Component Specifications
From Architecture Document (architecture.md#components):

**ProfessionalVerificationService:**
- Responsibility: Real-time credential validation with regulatory bodies
- Key Interfaces: PIRB/SAQCC/DOL API integrations, credential caching and renewal monitoring, manual verification fallback workflows
- Dependencies: External APIs, Redis cache, notification service
- Technology Stack: Express middleware, API clients, scheduled jobs

[Source: architecture.md#components]

### File Locations
From Architecture Document (architecture.md#unified-project-structure):

**Backend Integration Files:**
```
apps/api/src/
├── integrations/
│   ├── PIRBClient.ts
│   ├── SAQCCClient.ts
│   ├── DOLClient.ts
│   └── BaseAPIClient.ts
├── services/
│   └── VerificationService.ts
└── middleware/
    ├── rateLimit.ts
    └── audit.ts
```

[Source: architecture.md#unified-project-structure]

### Testing Requirements
From Architecture Document (architecture.md#testing-strategy):

**Integration Testing:**
- API endpoint testing with authentication
- External API integration testing (mocked)
- Multi-tenant data isolation testing

**Testing Commands:**
```bash
# Run integration tests only
pnpm test:integration

# Run all tests
pnpm test
```

[Source: architecture.md#testing-strategy]

### Technical Constraints
From Architecture Document (architecture.md#tech-stack):

**Backend Technology:**
- Framework: Express.js 4.18+
- Language: TypeScript 5.2+
- Cache: Redis 7.0+
- Monitoring: Sentry for error tracking

**Performance Targets:**
- Response Time Target: <200ms for API endpoints
- API health check completion: <5 seconds
- Error rate threshold: <10% failure rate triggers alerts

[Source: architecture.md#tech-stack, architecture.md#security-and-performance]

### Testing
Based on Architecture Document (architecture.md#testing-strategy):

**Unit Testing:**
- All API client methods must have unit tests
- Service layer testing for business logic
- Minimum 80% code coverage for business logic

**Integration Testing:**
- External API integration testing (mocked)
- Cache layer testing with Redis
- Error handling and fallback testing
- Audit logging validation

**Testing File Structure:**
```
apps/api/tests/
├── integrations/
│   ├── PIRBClient.test.ts
│   ├── SAQCCClient.test.ts
│   └── BaseAPIClient.test.ts
└── services/
    └── VerificationService.test.ts
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-18 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*This section is populated by the development agent during implementation*

### Agent Model Used
*Record the specific AI agent model and version used for development*

### Debug Log References
*Reference any debug logs or traces generated during development*

### Completion Notes List
*Notes about the completion of tasks and any issues encountered*

### File List
*List all files created, modified, or affected during story implementation*

## QA Results
*Results from QA Agent QA review of the completed story implementation*
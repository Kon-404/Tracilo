# Story 3.1: SANS-Compliant Checklist Templates & Engine

## Status
Draft

## Story
**As a** system architect,
**I want** SANS-compliant checklist templates and a dynamic form engine for all trade types,
**so that** field technicians can complete legally compliant inspections that meet South African regulatory standards.

## Acceptance Criteria

1. **SANS Template Creation:** Digital templates for electrical (SANS 10142-1:2024), solar (SANS 61215), plumbing (SANS 10252-1:2018), and gas (SANS 10087-1:2024) installations
2. **Dynamic Form Engine:** Flexible form rendering engine supporting conditional logic, validation rules, and complex field relationships
3. **Template Validation:** Comprehensive validation ensuring all required SANS fields are included and properly structured
4. **Conditional Logic System:** Smart form logic that shows/hides fields based on installation type, property classification, and previous responses
5. **Field Validation Framework:** Real-time validation with clear error messages and completion requirements
6. **Template Management:** Version control and update system for templates with backward compatibility

## Tasks / Subtasks

- [ ] **Task 1: SANS Template Research & Analysis** (AC: 1)
  - [ ] Research SANS 10142-1:2024 electrical installation requirements
  - [ ] Analyze SANS 61215 solar installation standards
  - [ ] Study SANS 10252-1:2018 plumbing installation requirements
  - [ ] Review SANS 10087-1:2024 gas installation standards
  - [ ] Create comprehensive field mapping for each trade type
  - [ ] Document mandatory vs optional fields per standard

- [ ] **Task 2: Template Schema Design** (AC: 1, 2)
  - [ ] Design JSON schema for checklist templates
  - [ ] Create field type system (text, number, checkbox, dropdown, photo, signature)
  - [ ] Implement section grouping and organization structure
  - [ ] Add field metadata (required, validation rules, descriptions)
  - [ ] Create template versioning schema
  - [ ] Design COC field mapping system

- [ ] **Task 3: Dynamic Form Engine Core** (AC: 2)
  - [ ] Create form field renderer with all supported types
  - [ ] Implement dynamic field generation from template schema
  - [ ] Add form state management with auto-save capability
  - [ ] Create field focus and navigation system
  - [ ] Implement form progress tracking
  - [ ] Add accessibility support for form fields

- [ ] **Task 4: Conditional Logic Engine** (AC: 4)
  - [ ] Design rule engine for show/hide field logic
  - [ ] Implement dependency tracking between fields
  - [ ] Add conditional validation based on field values
  - [ ] Create rule evaluation system for complex conditions
  - [ ] Implement cascading field updates
  - [ ] Add conditional required field marking

- [ ] **Task 5: Validation Framework** (AC: 5)
  - [ ] Create real-time field validation system
  - [ ] Implement trade-specific validation rules
  - [ ] Add custom validation messages for each field type
  - [ ] Create form completion validation
  - [ ] Implement cross-field validation checks
  - [ ] Add validation state management and error display

- [ ] **Task 6: Template Management System** (AC: 6)
  - [ ] Create template storage and retrieval system
  - [ ] Implement template versioning with migration support
  - [ ] Add template activation and deactivation
  - [ ] Create template import/export functionality
  - [ ] Implement template inheritance and customization
  - [ ] Add template audit trail and change tracking

- [ ] **Task 7: SANS Compliance Validation** (AC: 1, 3)
  - [ ] Create SANS compliance checker for each template
  - [ ] Validate all mandatory fields are present
  - [ ] Check field types match SANS requirements
  - [ ] Implement standard format validation
  - [ ] Add compliance reporting for templates
  - [ ] Create legal review preparation documentation

- [ ] **Task 8: Template Testing & Validation** (AC: 1, 2, 4)
  - [ ] Create comprehensive template validation tests
  - [ ] Test conditional logic scenarios for each trade
  - [ ] Validate form engine performance with complex templates
  - [ ] Test template versioning and migration
  - [ ] Validate SANS compliance for all templates
  - [ ] Performance test with large form datasets

## Dev Notes

### Previous Story Insights
Epic 2 provides the professional verification system that will validate technicians' qualifications before allowing access to specific trade templates.

### Data Models
From Architecture Document (architecture.md#data-models):

**ChecklistTemplate Structure:**
```typescript
interface ChecklistTemplate {
  id: string;
  organizationId?: string; // null for system templates
  name: string;
  tradeType: 'electrical' | 'solar' | 'plumbing' | 'gas' | 'hvac';
  version: string;
  sansStandard: string; // e.g., "SANS 10142-1:2024"
  schema: FormSchema;
  cocMapping: COCFieldMapping;
  isActive: boolean;
  createdAt: Date;
  updatedAt: Date;
}

interface FormSchema {
  sections: FormSection[];
  validationRules: ValidationRule[];
  conditionalLogic: ConditionalRule[];
}

interface FormSection {
  id: string;
  title: string;
  required: boolean;
  fields: FormField[];
  photoPrompts?: PhotoPrompt[];
}
```

[Source: architecture.md#data-models]

### Component Specifications
From Architecture Document (architecture.md#components):

**MobileFormEngine:**
- Responsibility: Dynamic form rendering with offline-first validation
- Key Interfaces: FormSchema processing and dynamic field generation, conditional logic execution and field visibility, auto-save functionality every 30 seconds
- Dependencies: SQLite storage, photo capture service, signature collection
- Technology Stack: React Native with Zustand state management, SQLite persistence, form validation

**ComplianceValidator:**
- Responsibility: SANS standard validation and COC generation
- Key Interfaces: Template validation against SANS standards, professional verification integration, PDF generation and digital signature embedding
- Dependencies: Professional credentials, regulatory APIs, PDF service

[Source: architecture.md#components]

### File Locations
From Architecture Document (architecture.md#unified-project-structure):

**Template & Form Engine Files:**
```
apps/mobile/src/
├── components/
│   └── forms/
│       ├── DynamicForm.tsx
│       ├── FormField.tsx
│       └── ConditionalLogic.tsx
├── services/
│   ├── TemplateService.ts
│   └── FormValidationService.ts
├── stores/
│   └── templateStore.ts
└── utils/
    └── formEngine/
        ├── fieldRenderers.ts
        ├── validationEngine.ts
        └── conditionalEngine.ts

packages/shared/src/
├── types/
│   ├── template.ts
│   └── formSchema.ts
└── schemas/
    └── templateValidation.ts
```

[Source: architecture.md#unified-project-structure]

### Testing Requirements
From Architecture Document (architecture.md#testing-strategy):

**Unit Testing:**
- Form field rendering components
- Conditional logic engine
- Validation rule execution
- Template schema validation

**Integration Testing:**
- Complete form workflow testing
- Template loading and rendering
- Validation system integration
- SANS compliance verification

[Source: architecture.md#testing-strategy]

### Technical Constraints
From Architecture Document (architecture.md#tech-stack):

**Mobile Technology:**
- React Native 0.74+ with New Architecture
- Zustand for state management
- SQLite for offline template storage
- React Native Elements for UI components

**Performance Requirements:**
- Template loading <2 seconds
- Form rendering <1 second for complex forms
- Auto-save every 30 seconds without UI blocking

[Source: architecture.md#tech-stack]

### SANS Standard Requirements
From Epic 3 Document (epic-3-core-compliance-mvp.md#mvp-scope-definition):

**In Scope Templates:**
- Electrical installations (SANS 10142-1:2024)
- Solar installations (SANS 61215)
- Plumbing installations (SANS 10252-1:2018)
- Gas installations (SANS 10087-1:2024)

**Template Requirements:**
- Pre-loaded templates for all trades
- Conditional logic for complex installation types
- Offline persistence with SQLite
- Progress indicators and completion validation
- Required field enforcement

[Source: epic-3-core-compliance-mvp.md#mvp-scope-definition]

### Performance Targets
From Epic 3 Document (epic-3-core-compliance-mvp.md#success-criteria):

**Success Criteria:**
- <3 second app launch time on mid-range Android devices
- 100% compliance with SANS standards for each trade
- Legal validity of generated COCs verified by attorney
- Zero data loss during offline operation

[Source: epic-3-core-compliance-mvp.md#success-criteria]

### Testing
Based on Architecture Document (architecture.md#testing-strategy):

**Unit Testing:**
- Form field components with different types
- Conditional logic engine scenarios
- Validation rule execution
- Template schema validation

**Integration Testing:**
- Complete template loading workflow
- Form state management and auto-save
- Conditional logic interaction testing
- SANS compliance validation

**SANS Compliance Testing:**
- Each trade template against official standards
- Required field verification
- Field type and format validation
- Legal compliance preparation

**Testing File Structure:**
```
apps/mobile/tests/
├── components/
│   └── forms/
│       ├── DynamicForm.test.tsx
│       └── FormField.test.tsx
├── services/
│   ├── TemplateService.test.ts
│   └── FormValidationService.test.ts
├── utils/
│   └── formEngine/
│       ├── validationEngine.test.ts
│       └── conditionalEngine.test.ts
└── integration/
    ├── template-loading.test.ts
    └── sans-compliance.test.ts
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-18 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*This section is populated by the development agent during implementation*

### Agent Model Used
*Record the specific AI agent model and version used for development*

### Debug Log References
*Reference any debug logs or traces generated during development*

### Completion Notes List
*Notes about the completion of tasks and any issues encountered*

### File List
*List all files created, modified, or affected during story implementation*

## QA Results
*Results from QA Agent QA review of the completed story implementation*
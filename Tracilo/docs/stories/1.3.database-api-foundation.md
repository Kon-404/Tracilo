# Story 1.3: Database & API Foundation Setup

## Status
Draft

## Story
**As a** backend developer,
**I want** a functional database schema and API foundation with basic CRUD operations,
**so that** I can begin implementing compliance features with proper data persistence and API structure.

## Acceptance Criteria

1. **Database Schema:** PostgreSQL database created with core tables (organizations, users, sites, checklist_templates) and proper relationships
2. **API Foundation:** Express.js server with tRPC router configuration and basic middleware setup
3. **Database ORM:** Prisma ORM configured with schema file and migration system working
4. **Basic CRUD:** Functional CRUD operations for organizations and users with proper validation
5. **Authentication Setup:** Supabase Auth integration with user session management
6. **API Testing:** Basic API endpoints tested and documented with Postman/Thunder Client collections

## Tasks / Subtasks

- [ ] **Task 1: Database Schema Setup** (AC: 1, 3)
  - [ ] Create Prisma schema file with core models
  - [ ] Define Organization model with settings and compliance fields
  - [ ] Define User model with professional credentials
  - [ ] Define Site model with GPS coordinates and client info
  - [ ] Define ChecklistTemplate model with SANS standards
  - [ ] Configure database relationships and constraints
  - [ ] Run initial migration to create tables

- [ ] **Task 2: Express.js & tRPC Server Setup** (AC: 2)
  - [ ] Initialize Express.js server with TypeScript
  - [ ] Configure tRPC with Express adapter
  - [ ] Setup CORS middleware for development
  - [ ] Configure body parsing and request logging
  - [ ] Setup error handling middleware
  - [ ] Configure development server with hot reload

- [ ] **Task 3: Supabase Integration** (AC: 5)
  - [ ] Setup Supabase client in backend
  - [ ] Configure Supabase Auth provider
  - [ ] Implement JWT verification middleware
  - [ ] Setup Row Level Security policies
  - [ ] Configure user session management
  - [ ] Test authentication flow

- [ ] **Task 4: Core API Routes** (AC: 4)
  - [ ] Create organization CRUD router
  - [ ] Create user CRUD router with professional verification
  - [ ] Implement input validation with Zod schemas
  - [ ] Add proper error handling and responses
  - [ ] Setup API response standardization
  - [ ] Add request logging and monitoring

- [ ] **Task 5: Database Seeding** (AC: 1)
  - [ ] Create seed script for development data
  - [ ] Add sample organizations and users
  - [ ] Create SANS-compliant checklist templates
  - [ ] Add development sites with realistic data
  - [ ] Setup environment-specific seeding

- [ ] **Task 6: API Documentation & Testing** (AC: 6)
  - [ ] Generate tRPC API documentation
  - [ ] Create Postman collection for API testing
  - [ ] Write integration tests for CRUD operations
  - [ ] Test authentication and authorization flows
  - [ ] Validate database constraints and relationships
  - [ ] Document API endpoints and schemas

## Dev Notes

### Database Schema Design
From Architecture Document (architecture.md#database-schema):

**Core Tables:**
```sql
-- Organizations with row-level security
CREATE TABLE organizations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    subscription_tier subscription_tier_enum NOT NULL DEFAULT 'basic',
    settings JSONB NOT NULL DEFAULT '{}',
    compliance_settings JSONB NOT NULL DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Users with professional verification
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID NOT NULL REFERENCES organizations(id),
    email VARCHAR(255) UNIQUE NOT NULL,
    role user_role_enum NOT NULL DEFAULT 'technician',
    professional_credentials JSONB NOT NULL DEFAULT '[]',
    verification_status verification_status_enum NOT NULL DEFAULT 'pending'
);
```

### Prisma Schema Configuration
From Architecture Document (architecture.md#data-access-layer):

**Key Models:**
- Organization: Multi-tenant organization management
- User: Professional technicians with verified credentials
- Site: Physical locations with GPS coordinates
- ChecklistTemplate: SANS-compliant inspection workflows

**Important Relationships:**
- One-to-many: Organization → Users
- One-to-many: Organization → Sites
- Many-to-one: User → Organization

### tRPC Router Structure
From Architecture Document (architecture.md#api-specification):

**Router Organization:**
```typescript
export const appRouter = router({
  organization: organizationRouter,
  user: userRouter,
  site: siteRouter,
  checklistTemplate: checklistTemplateRouter
});

// Example organization router
export const organizationRouter = router({
  create: procedure.input(createOrgSchema).mutation(),
  getById: procedure.input(z.object({ id: z.string() })).query(),
  update: procedure.input(updateOrgSchema).mutation(),
  delete: procedure.input(z.object({ id: z.string() })).mutation()
});
```

### Authentication Middleware
From Architecture Document (architecture.md#authentication-and-authorization):

**JWT Verification:**
```typescript
export const authMiddleware = async (opts: any) => {
  const token = opts.req.headers.authorization?.replace('Bearer ', '');

  if (!token) {
    throw new TRPCError({
      code: 'UNAUTHORIZED',
      message: 'Authentication required'
    });
  }

  const user = await verifyJWT(token);
  return opts.next({ ctx: { user } });
};
```

### Supabase Configuration
From Architecture Document (architecture.md#tech-stack):

**Supabase Setup:**
- Authentication provider: Supabase Auth
- Database: Supabase PostgreSQL
- Row Level Security enabled for multi-tenant isolation
- Real-time subscriptions for dashboard updates

### Database Connection
From Architecture Document (architecture.md#environment-configuration):

**Connection String:**
```bash
DATABASE_URL=postgresql://postgres:password@localhost:5432/tracilo_dev
SUPABASE_URL=your_supabase_project_url
SUPABASE_SERVICE_KEY=your_supabase_service_key
SUPABASE_ANON_KEY=your_supabase_anon_key
```

### Professional Verification Schema
From Product Requirements Document (product-requirements.md#professional-verification):

**Professional Credentials:**
```typescript
interface ProfessionalCredential {
  tradeType: 'electrical' | 'solar' | 'plumbing' | 'gas' | 'hvac';
  registrationNumber: string;
  issuingBody: 'PIRB' | 'SAQCC_GAS' | 'DOL' | 'ECSA';
  expiryDate: Date;
  status: 'active' | 'expired' | 'suspended';
}
```

### Error Handling Standards
From Architecture Document (architecture.md#error-handling-strategy):

**API Error Format:**
```typescript
interface ApiError {
  error: {
    code: string;
    message: string;
    details?: Record<string, any>;
    timestamp: string;
    requestId: string;
  };
}
```

### Performance Requirements
From Product Requirements Document (product-requirements.md#technical-requirements):

**API Performance:**
- Response time: <200ms for CRUD operations
- Database query optimization with proper indexing
- Connection pooling for concurrent requests
- Caching with Redis for frequent queries

### Testing
Based on Architecture Document (architecture.md#testing-strategy):

**Database Testing:**
- Test database migrations up and down
- Validate schema constraints and relationships
- Test Row Level Security policies
- Verify data seeding scripts

**API Testing:**
- Test all CRUD operations for each model
- Validate input sanitization and validation
- Test authentication and authorization flows
- Verify error handling and response formats

**Test File Locations:**
- API tests: `apps/api/tests/integration/`
- Database tests: `apps/api/tests/database/`
- Schema tests: `apps/api/tests/schema/`

**Testing Commands:**
```bash
# Run database tests
pnpm test:db

# Run API integration tests
pnpm test:api

# Test migrations
pnpm db:test-migration

# Reset test database
pnpm db:reset:test
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-18 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record
*This section is populated by the development agent during implementation*

### Agent Model Used
*Record the specific AI agent model and version used for development*

### Debug Log References
*Reference any debug logs or traces generated during development*

### Completion Notes List
*Notes about the completion of tasks and any issues encountered*

### File List
*List all files created, modified, or affected during story implementation*

## QA Results
*Results from QA Agent QA review of the completed story implementation*
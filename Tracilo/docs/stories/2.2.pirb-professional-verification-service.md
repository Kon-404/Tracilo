# Story 2.2: PIRB Professional Verification Service

## Status
Draft

## Story
**As a** plumbing operations manager,
**I want** real-time verification of plumber credentials with the PIRB database,
**so that** only verified plumbing professionals can issue plumbing-related Certificates of Compliance.

## Acceptance Criteria

1. **PIRB API Integration:** Direct integration with PIRB database API to verify plumbing registration numbers and professional status
2. **Real-time Verification:** Live credential validation during user onboarding and before COC generation (<5 seconds response time)
3. **Credential Validation:** Comprehensive validation of registration numbers, license categories, expiry dates, and professional standing
4. **Cache Management:** Intelligent caching of verification results with automatic invalidation before expiry dates
5. **Professional Standing:** Monitoring of professional status changes and automatic user notification for suspended/expired licenses
6. **Trade Category Validation:** Verification of specific plumbing trade categories and work authorization scope

## Tasks / Subtasks

- [ ] **Task 1: PIRB API Client Implementation** (AC: 1, 2)
  - [ ] Extend BaseAPIClient for PIRB-specific endpoints
  - [ ] Configure PIRB API credentials and certificate-based authentication
  - [ ] Implement POST /verify-professional endpoint integration
  - [ ] Add PIRB-specific request/response data models
  - [ ] Configure rate limiting (100 requests/minute per PIRB limits)
  - [ ] Add PIRB API health checks and connectivity monitoring

- [ ] **Task 2: Registration Number Validation** (AC: 3)
  - [ ] Implement PIRB registration number format validation
  - [ ] Create validation for plumbing license categories
  - [ ] Add expiry date checking and validation logic
  - [ ] Implement professional standing status verification
  - [ ] Add trade category and authorization scope validation
  - [ ] Create comprehensive validation response handling

- [ ] **Task 3: Credential Caching Strategy** (AC: 4)
  - [ ] Implement PIRB-specific cache keys (pirb:reg:{number})
  - [ ] Configure cache TTL based on license expiry (max 24h)
  - [ ] Add automatic cache invalidation 30 days before expiry
  - [ ] Implement cache warming for frequently verified professionals
  - [ ] Add cache refresh logic for status updates
  - [ ] Create cache metrics and monitoring

- [ ] **Task 4: Professional Status Monitoring** (AC: 5)
  - [ ] Create periodic re-verification job for active users
  - [ ] Implement status change detection and notification
  - [ ] Add automated user account suspension for expired licenses
  - [ ] Create professional standing alert system
  - [ ] Implement grace period handling for renewal processing
  - [ ] Add manual override capabilities for emergency situations

- [ ] **Task 5: Trade Category Authorization** (AC: 6)
  - [ ] Map PIRB trade categories to Tracilo COC types
  - [ ] Implement authorization scope validation
  - [ ] Add restrictions for specialized plumbing work
  - [ ] Create trade category verification for COC generation
  - [ ] Implement category-based permission system
  - [ ] Add validation for cross-category work authorization

- [ ] **Task 6: PIRB Integration Testing** (AC: 1, 2, 3)
  - [ ] Create PIRB mock server for development testing
  - [ ] Write integration tests for all PIRB endpoints
  - [ ] Test error scenarios and API failures
  - [ ] Validate caching behavior and invalidation
  - [ ] Performance test with realistic load patterns
  - [ ] Test professional status monitoring workflows

## Dev Notes

### Previous Story Insights
Story 2.1 provides the BaseAPIClient foundation and external API integration framework that this story builds upon for PIRB-specific implementation.

### Data Models
From Architecture Document (architecture.md#data-models):

**Professional Credential Structure:**
```typescript
interface ProfessionalCredential {
  tradeType: 'plumbing';
  registrationNumber: string;
  issuingBody: 'PIRB';
  expiryDate: Date;
  verificationDate: Date;
  status: 'active' | 'expired' | 'suspended';
}

interface PIRBVerificationResponse {
  registrationNumber: string;
  professionalName: string;
  licenseStatus: 'active' | 'expired' | 'suspended';
  expiryDate: Date;
  tradeCategories: string[];
  restrictions?: string[];
  lastUpdated: Date;
}
```

[Source: architecture.md#data-models]

### API Specifications
From Architecture Document (architecture.md#external-apis):

**PIRB Database API:**
- Purpose: Plumbing professional verification
- Base URL: https://api.pirb.co.za/v1
- Authentication: API key + certificate-based
- Rate Limits: 100 requests/minute
- Key Endpoint: POST /verify-professional

**Integration Notes:**
- Fallback to manual verification if API unavailable
- Cache results for 24 hours
- Critical for plumbing COC generation compliance

[Source: architecture.md#external-apis]

### Component Specifications
From Architecture Document (architecture.md#components):

**ProfessionalVerificationService Implementation:**
- PIRB API integration with credential caching
- Renewal monitoring and status change detection
- Manual verification fallback workflows
- Redis cache integration for performance
- Scheduled jobs for periodic re-verification

[Source: architecture.md#components]

### File Locations
From Architecture Document (architecture.md#unified-project-structure):

**PIRB Integration Files:**
```
apps/api/src/
├── integrations/
│   └── PIRBClient.ts
├── services/
│   └── VerificationService.ts
├── routers/
│   └── verification.ts
└── types/
    └── pirb.ts
```

[Source: architecture.md#unified-project-structure]

### Testing Requirements
From Architecture Document (architecture.md#testing-strategy):

**Integration Testing:**
- PIRB API endpoint testing with authentication
- Professional verification workflow testing
- Cache layer testing for credential storage
- Error handling and fallback mechanism testing

**Performance Testing:**
- Verification response time <5 seconds
- Cache hit rate optimization
- Rate limiting validation

[Source: architecture.md#testing-strategy]

### Technical Constraints
From Architecture Document (architecture.md#tech-stack):

**Authentication Requirements:**
- API key management for PIRB access
- Certificate-based authentication setup
- Secure credential storage and rotation

**Compliance Requirements:**
- Complete audit trail for all verification attempts
- POPIA compliance for personal data handling
- 7-year audit log retention for regulatory compliance

[Source: architecture.md#tech-stack]

### Regulatory Compliance Requirements
From Epic 2 Document (epic-2-professional-verification.md#regulatory-compliance-requirements):

**PIRB Integration Requirements:**
- Validate plumbing registration numbers
- Verify current professional status
- Check license expiry dates
- Validate trade categories and restrictions

**Security Requirements:**
- Encrypted credential storage (SQLCipher)
- API key management and rotation
- Complete audit trail for verification attempts
- POPIA compliance for personal data

[Source: epic-2-professional-verification.md#regulatory-compliance-requirements]

### Testing
Based on Architecture Document (architecture.md#testing-strategy):

**Unit Testing:**
- PIRBClient method testing with mocked responses
- Credential validation logic testing
- Cache management function testing
- Professional status monitoring testing

**Integration Testing:**
- PIRB API integration with live/mock endpoints
- Database storage and retrieval testing
- Redis cache integration testing
- Error handling and fallback testing

**Testing File Structure:**
```
apps/api/tests/
├── integrations/
│   └── PIRBClient.test.ts
├── services/
│   └── VerificationService.test.ts
└── integration/
    └── pirb-verification.test.ts
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-18 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*This section is populated by the development agent during implementation*

### Agent Model Used
*Record the specific AI agent model and version used for development*

### Debug Log References
*Reference any debug logs or traces generated during development*

### Completion Notes List
*Notes about the completion of tasks and any issues encountered*

### File List
*List all files created, modified, or affected during story implementation*

## QA Results
*Results from QA Agent QA review of the completed story implementation*
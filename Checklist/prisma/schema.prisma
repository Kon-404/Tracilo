// Prisma Schema for Checklist App
// Database: PostgreSQL (Supabase)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL") // Uses connection pooling (Vercel Supabase Integration)
  directUrl = env("POSTGRES_URL_NON_POOLING") // Direct connection for migrations
}

// Organization - Company or team workspace
model Organization {
  id        String   @id @default(cuid())
  name      String   @unique // Globally unique organization name
  slug      String   @unique // URL-friendly identifier
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members     OrganizationMember[]
  submissions FormSubmission[]
  invites     PendingInvite[]
  templates   FormTemplate[]

  @@map("organizations")
}

// User Profile - Extends Supabase auth.users
model UserProfile {
  id                   String   @id // Matches Supabase auth.users.id
  email                String   @unique
  fullName             String?
  avatarUrl            String?
  activeOrganizationId String?  // Currently selected organization
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  memberships      OrganizationMember[]
  submissions      FormSubmission[]
  sentInvites      PendingInvite[]
  createdTemplates FormTemplate[]

  @@map("user_profiles")
}

// Organization Member - Links users to organizations
model OrganizationMember {
  id                String   @id @default(cuid())
  organizationId    String
  userId            String
  role              String   @default("member") // owner, admin, member, viewer
  customPermissions Json?    // Custom permissions override for this member
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         UserProfile  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
  @@map("organization_members")
}

// Form Template - Reusable checklist template
model FormTemplate {
  id             String        @id @default(cuid())
  name           String
  category       String        // vehicle, solar, gas, etc.
  description    String
  icon           String?       // emoji or icon identifier
  version        Int           @default(1)
  organizationId String?       // null = system template, not null = org-specific
  createdBy      String?       // User ID who created the template
  isPublic       Boolean       @default(false) // Allow other orgs to use this template
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  sections     FormSection[]
  submissions  FormSubmission[]
  organization Organization?  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  creator      UserProfile?   @relation(fields: [createdBy], references: [id], onDelete: SetNull)

  @@index([category])
  @@index([organizationId])
  @@map("form_templates")
}

// Form Section - Logical grouping within a template
model FormSection {
  id          String      @id @default(cuid())
  templateId  String
  title       String
  description String?
  order       Int         // Display order within template

  template    FormTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  fields      FormField[]

  @@index([templateId])
  @@map("form_sections")
}

// Form Field - Individual input field
model FormField {
  id          String  @id @default(cuid())
  sectionId   String
  type        String  // text, textarea, number, dropdown, checkbox, date, time, photo, signature
  label       String
  placeholder String?
  helpText    String?
  required    Boolean @default(false)
  order       Int     // Display order within section
  config      Json?   // Type-specific configuration (options, min, max, etc.)

  section     FormSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  @@index([sectionId])
  @@map("form_fields")
}

// Form Submission - Completed form instance
model FormSubmission {
  id             String   @id @default(cuid())
  templateId     String
  templateName   String   // Denormalized for easier querying
  category       String   // Denormalized
  submittedAt    DateTime @default(now())
  submittedBy    String?  // Denormalized user name for display
  userId         String   // Link to UserProfile
  organizationId String   // Link to Organization
  status         String   @default("completed") // draft, completed
  metadata       Json?    // GPS, device info, etc.

  template     FormTemplate  @relation(fields: [templateId], references: [id])
  user         UserProfile   @relation(fields: [userId], references: [id])
  organization Organization  @relation(fields: [organizationId], references: [id])
  answers      FormAnswer[]

  @@index([templateId])
  @@index([submittedAt])
  @@index([category])
  @@index([userId])
  @@index([organizationId])
  @@map("form_submissions")
}

// Form Answer - Individual field response
model FormAnswer {
  id           String  @id @default(cuid())
  submissionId String
  fieldId      String  // Reference to FormField (soft reference)
  fieldLabel   String  // Denormalized for PDF generation
  fieldType    String  // Denormalized
  sectionTitle String  // Denormalized for grouping
  value        Json?   // Flexible value storage (string, number, boolean, array)
  photoUrls    String[] // Future: uploaded photo URLs

  submission   FormSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@index([submissionId])
  @@map("form_answers")
}

// Pending Invite - Invitation to join organization
model PendingInvite {
  id             String   @id @default(cuid())
  organizationId String
  email          String
  role           String   @default("member") // Role to assign when accepted
  invitedBy      String   // User ID who sent the invite
  token          String   @unique  // Unique token for email verification
  expiresAt      DateTime // Expiration date (default 7 days)
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  inviter      UserProfile  @relation(fields: [invitedBy], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([token])
  @@index([organizationId])
  @@map("pending_invites")
}
